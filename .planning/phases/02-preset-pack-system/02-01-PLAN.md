---
phase: 02-preset-pack-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/services/packs/types.ts
  - src-tauri/migrations/025_preset_packs.sql
  - src-tauri/src/lib.rs
autonomous: true

must_haves:
  truths:
    - "Pack type definitions compile and express all locked decisions (name, description, author, 5 variable types, label+value enum options, variable_name+display_name)"
    - "Migration 025 creates preset_packs, pack_templates, and pack_variables tables with correct constraints"
    - "Migration adds pack_id column to stories table with ON DELETE RESTRICT"
    - "Migration seeds default pack row and assigns it to existing stories"
    - "Migration is registered in lib.rs and will run on app startup"
  artifacts:
    - path: "src/lib/services/packs/types.ts"
      provides: "Pack, PackTemplate, CustomVariable, EnumOption interfaces and CustomVariableType"
      min_lines: 60
    - path: "src-tauri/migrations/025_preset_packs.sql"
      provides: "DDL for preset_packs, pack_templates, pack_variables tables + stories ALTER"
      contains: "CREATE TABLE IF NOT EXISTS preset_packs"
    - path: "src-tauri/src/lib.rs"
      provides: "Migration 25 registration"
      contains: "025_preset_packs.sql"
  key_links:
    - from: "src/lib/services/packs/types.ts"
      to: "src-tauri/migrations/025_preset_packs.sql"
      via: "TypeScript types mirror SQL schema columns"
      pattern: "variable_type.*text.*textarea.*enum.*number.*boolean"
---

<objective>
Define the data model and database schema for the preset pack system.

Purpose: Establish the foundational types and database tables that all subsequent pack operations build on. Types define the shape of data in TypeScript; the migration creates the corresponding SQLite tables with proper constraints and seeds the default pack.

Output: Pack type definitions, SQLite migration file, and lib.rs registration.
</objective>

<execution_context>
@C:/Users/Admin/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-preset-pack-system/02-CONTEXT.md
@.planning/phases/02-preset-pack-system/02-RESEARCH.md
@.planning/codebase/CONVENTIONS.md

# Phase 1 types for reference (VariableType is 'text' | 'number' | 'boolean' | 'enum')
@src/lib/services/templates/types.ts

# Existing migration registration pattern
@src-tauri/src/lib.rs

# Existing prompt templates (source of truth for template IDs)
@src/lib/services/prompts/templates/index.ts
@src/lib/services/prompts/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pack type definitions</name>
  <files>src/lib/services/packs/types.ts</files>
  <action>
Create `src/lib/services/packs/types.ts` with the following type definitions. Follow codebase conventions: no semicolons, single quotes, PascalCase types, camelCase properties, trailing commas.

**CustomVariableType** (NOT the same as Phase 1's VariableType):
```
type CustomVariableType = 'text' | 'textarea' | 'enum' | 'number' | 'boolean'
```
Five types per user locked decision. This is distinct from Phase 1's VariableType (which has 'text' | 'number' | 'boolean' | 'enum') because packs add 'textarea'.

**EnumOption** interface:
```
interface EnumOption {
  label: string   // Display text (e.g., "Fantasy")
  value: string   // Stored value (e.g., "fantasy")
}
```
Per user locked decision: enum variables use label+value pairs.

**CustomVariable** interface:
```
interface CustomVariable {
  id: string
  packId: string
  variableName: string    // Used in templates: {{ writing_style }}
  displayName: string     // Shown in UI: "Writing Style"
  variableType: CustomVariableType
  isRequired: boolean
  defaultValue?: string   // Stored as string, parsed by type
  enumOptions?: EnumOption[]  // Only for enum type
  createdAt: number       // Epoch milliseconds
}
```
Per user locked decision: variables have both variable_name (template use) and display_name (UI display).

**PackTemplate** interface:
```
interface PackTemplate {
  id: string
  packId: string
  templateId: string      // References PROMPT_TEMPLATES[].id
  content: string         // Liquid template string
  contentHash: string     // SHA-256 of normalized content
  createdAt: number
  updatedAt: number
}
```

**PresetPack** interface:
```
interface PresetPack {
  id: string
  name: string
  description: string | null
  author: string | null
  isDefault: boolean
  createdAt: number
  updatedAt: number
}
```
Per user locked decision: packs have name, description, and author fields. No version field (user locked: no versioning).

**FullPack** interface (convenience type for loading pack with all children):
```
interface FullPack {
  pack: PresetPack
  templates: PackTemplate[]
  variables: CustomVariable[]
}
```

Export all types. Add JSDoc comments on each interface explaining its purpose. Add a file-level doc comment explaining the pack type system.

IMPORTANT: Do NOT add 'textarea' to Phase 1's VariableType in `src/lib/services/templates/types.ts`. The pack system defines its own CustomVariableType separately. Phase 1 types remain unchanged.
  </action>
  <verify>Run `npx tsc --noEmit --pretty` (or `npx svelte-check`) to confirm types compile without errors. Verify file exports CustomVariableType, EnumOption, CustomVariable, PackTemplate, PresetPack, FullPack.</verify>
  <done>All pack type definitions exist in src/lib/services/packs/types.ts, compile cleanly, and express the full data model per user locked decisions (5 variable types, label+value enums, variable_name+display_name, no version field).</done>
</task>

<task type="auto">
  <name>Task 2: Create SQLite migration and register in lib.rs</name>
  <files>src-tauri/migrations/025_preset_packs.sql, src-tauri/src/lib.rs</files>
  <action>
Create `src-tauri/migrations/025_preset_packs.sql` with the following SQL. Follow existing migration conventions (CREATE TABLE IF NOT EXISTS, INTEGER for timestamps and booleans, TEXT for IDs):

```sql
-- Enable foreign keys (ensure enforcement for this migration)
PRAGMA foreign_keys = ON;

-- Pack metadata
CREATE TABLE IF NOT EXISTS preset_packs (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  description TEXT,
  author TEXT,
  is_default INTEGER NOT NULL DEFAULT 0,
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL,
  UNIQUE(name)
);

-- Template content within packs
CREATE TABLE IF NOT EXISTS pack_templates (
  id TEXT PRIMARY KEY,
  pack_id TEXT NOT NULL,
  template_id TEXT NOT NULL,
  content TEXT NOT NULL,
  content_hash TEXT NOT NULL,
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL,
  FOREIGN KEY (pack_id) REFERENCES preset_packs(id) ON DELETE CASCADE,
  UNIQUE(pack_id, template_id)
);

-- Custom variable definitions per pack
CREATE TABLE IF NOT EXISTS pack_variables (
  id TEXT PRIMARY KEY,
  pack_id TEXT NOT NULL,
  variable_name TEXT NOT NULL,
  display_name TEXT NOT NULL,
  variable_type TEXT NOT NULL,
  is_required INTEGER NOT NULL DEFAULT 0,
  default_value TEXT,
  enum_options TEXT,
  created_at INTEGER NOT NULL,
  FOREIGN KEY (pack_id) REFERENCES preset_packs(id) ON DELETE CASCADE,
  UNIQUE(pack_id, variable_name)
);

-- Track which story uses which pack
ALTER TABLE stories ADD COLUMN pack_id TEXT REFERENCES preset_packs(id) ON DELETE RESTRICT;

-- Seed default pack
INSERT INTO preset_packs (id, name, description, author, is_default, created_at, updated_at)
VALUES (
  'default-pack',
  'Default',
  'Built-in prompt templates shipped with Aventura',
  'Aventura',
  1,
  strftime('%s', 'now') * 1000,
  strftime('%s', 'now') * 1000
);

-- Assign default pack to all existing stories
UPDATE stories SET pack_id = 'default-pack' WHERE pack_id IS NULL;

-- Performance indexes
CREATE INDEX IF NOT EXISTS idx_pack_templates_pack ON pack_templates(pack_id);
CREATE INDEX IF NOT EXISTS idx_pack_variables_pack ON pack_variables(pack_id);
CREATE INDEX IF NOT EXISTS idx_stories_pack ON stories(pack_id);
```

Key design notes:
- pack_id on stories is nullable (ALTER TABLE cannot add NOT NULL to populated table in SQLite) but we immediately UPDATE all existing rows to 'default-pack'
- ON DELETE CASCADE for pack children (templates, variables) -- deleting pack removes all children
- ON DELETE RESTRICT for stories -> packs -- cannot delete pack while stories reference it
- UNIQUE(pack_id, template_id) prevents duplicate templates per pack
- UNIQUE(pack_id, variable_name) prevents duplicate variable names per pack
- enum_options stored as JSON TEXT (array of {label, value} objects), nullable for non-enum types
- Template content seeding happens in TypeScript at runtime, not in SQL migration (PROMPT_TEMPLATES is the source of truth in TypeScript)

Then update `src-tauri/src/lib.rs` to register migration 25. Add a new Migration struct entry at the end of the `migrations` vec, following the exact pattern of existing entries:

```rust
Migration {
    version: 25,
    description: "preset_packs",
    sql: include_str!("../migrations/025_preset_packs.sql"),
    kind: MigrationKind::Up,
},
```

Add a trailing comma after migration 24's closing brace (if not already present) before adding migration 25.
  </action>
  <verify>Verify the SQL file exists and contains all three CREATE TABLE statements, the ALTER TABLE, the INSERT, and the UPDATE. Verify lib.rs contains `version: 25` and references `025_preset_packs.sql`. Run `npx svelte-check` to ensure no TypeScript regressions.</verify>
  <done>Migration 025_preset_packs.sql creates all three tables with correct constraints, seeds the default pack, assigns it to existing stories, and is registered in lib.rs as migration version 25.</done>
</task>

</tasks>

<verification>
- [ ] src/lib/services/packs/types.ts exists and exports PresetPack, PackTemplate, CustomVariable, FullPack, CustomVariableType, EnumOption
- [ ] CustomVariableType includes all 5 types: text, textarea, enum, number, boolean
- [ ] EnumOption has label and value fields
- [ ] CustomVariable has variableName AND displayName (both required)
- [ ] PresetPack has NO version field
- [ ] src-tauri/migrations/025_preset_packs.sql creates preset_packs, pack_templates, pack_variables tables
- [ ] stories table gets pack_id column with ON DELETE RESTRICT
- [ ] Default pack is seeded with id 'default-pack', is_default=1
- [ ] Existing stories are updated to use default pack
- [ ] lib.rs registers migration version 25
- [ ] TypeScript compilation passes (svelte-check)
</verification>

<success_criteria>
Pack data model is fully defined in TypeScript and SQL. Types compile cleanly. Migration is registered and will create tables + seed default pack on next app launch. No changes to Phase 1 template engine types.
</success_criteria>

<output>
After completion, create `.planning/phases/02-preset-pack-system/02-01-SUMMARY.md`
</output>
