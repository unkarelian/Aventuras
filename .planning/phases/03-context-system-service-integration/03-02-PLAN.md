---
phase: 03-context-system-service-integration
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/lib/services/prompts/templates/narrative.ts
  - src/lib/services/prompts/templates/analysis.ts
  - src/lib/services/prompts/templates/memory.ts
  - src/lib/services/prompts/templates/suggestions.ts
  - src/lib/services/prompts/templates/generation.ts
  - src/lib/services/prompts/templates/wizard.ts
  - src/lib/services/prompts/templates/translation.ts
  - src/lib/services/prompts/templates/image.ts
autonomous: true

must_haves:
  truths:
    - "All prompt templates use Liquid syntax ({{ variable }} and {% if/elsif/else/endif %}) instead of MacroEngine macro tokens"
    - "Variant logic that was in MacroEngine is now expressed as Liquid conditionals inside templates"
    - "Templates are self-contained with no partials or includes"
    - "Each template works with a flat context object where variables are accessed directly"
  artifacts:
    - path: "src/lib/services/prompts/templates/narrative.ts"
      provides: "Adventure and creative-writing narrative templates in Liquid syntax"
      contains: "{% if mode"
    - path: "src/lib/services/prompts/templates/analysis.ts"
      provides: "Classifier template in Liquid syntax"
      contains: "{% if"
    - path: "src/lib/services/prompts/templates/wizard.ts"
      provides: "Wizard templates in Liquid syntax"
      contains: "{{ genre"
    - path: "src/lib/services/prompts/templates/translation.ts"
      provides: "Translation templates in Liquid syntax"
      contains: "{{ targetLanguage"
  key_links:
    - from: "src/lib/services/prompts/templates/*.ts"
      to: "src/lib/services/context/context-builder.ts"
      via: "ContextBuilder.render() loads and renders these templates"
      pattern: "content:"
---

<objective>
Convert all prompt templates from the old MacroEngine {{macro}} syntax to Liquid template syntax with conditionals.

Purpose: The ContextBuilder (Plan 01) renders templates through LiquidJS. Currently, templates use `{{macroName}}` tokens that get resolved through the MacroEngine's variant/scoring system. These need to become proper Liquid templates with `{{ variable }}` for direct substitution and `{% if mode == 'adventure' %}` for conditional logic. This is the critical bridge between the old and new systems.

Output: All template files in `src/lib/services/prompts/templates/` rewritten with Liquid syntax. The PROMPT_TEMPLATES array structure stays the same (id, name, category, content, userContent) -- only the content strings change.
</objective>

<execution_context>
@C:/Users/Admin/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-context-system-service-integration/03-CONTEXT.md
@.planning/phases/03-context-system-service-integration/03-RESEARCH.md
@.planning/phases/03-context-system-service-integration/03-01-SUMMARY.md

# Current templates to convert
@src/lib/services/prompts/templates/narrative.ts
@src/lib/services/prompts/templates/analysis.ts
@src/lib/services/prompts/templates/memory.ts
@src/lib/services/prompts/templates/suggestions.ts
@src/lib/services/prompts/templates/generation.ts
@src/lib/services/prompts/templates/wizard.ts
@src/lib/services/prompts/templates/translation.ts
@src/lib/services/prompts/templates/image.ts
@src/lib/services/prompts/templates/index.ts

# Old macro definitions (to understand what macros resolve to)
@src/lib/services/prompts/definitions/macros/core.ts
@src/lib/services/prompts/definitions/macros/narrative.ts
@src/lib/services/prompts/definitions/macros/features.ts
@src/lib/services/prompts/definitions/macros/context.ts
@src/lib/services/prompts/definitions/macros/placeholders.ts
@src/lib/services/prompts/macros.ts

# ContextBuilder types (to know available variables)
@src/lib/services/context/types.ts
@src/lib/services/context/runtime-variables.ts

# systemBuilder.ts (to understand what instruction text moves to templates vs what stays as data formatting)
@src/lib/services/ai/prompts/systemBuilder.ts

# Phase 1 template engine (to verify Liquid syntax compatibility)
@src/lib/services/templates/engine.ts
@src/lib/services/templates/variables.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert story and analysis templates to Liquid syntax</name>
  <files>
    src/lib/services/prompts/templates/narrative.ts
    src/lib/services/prompts/templates/analysis.ts
    src/lib/services/prompts/templates/suggestions.ts
    src/lib/services/prompts/templates/generation.ts
  </files>
  <action>
For each template file, convert the content strings from MacroEngine syntax to Liquid syntax. The key transformation rules:

**Macro tokens to Liquid variables:**
- `{{protagonistName}}` stays as `{{ protagonistName }}` (same syntax, just Liquid now)
- `{{styleInstruction}}` (complex macro with variants) becomes inline `{% if %}` conditionals
- `{{responseInstruction}}` becomes inline conditionals
- All other complex macros with mode/pov/tense variants become `{% if %}` blocks

**Complex macro resolution:**
Read the macro definitions in `definitions/macros/` to understand what each complex macro resolves to for each mode/pov/tense combination. Then inline that logic as Liquid conditionals.

For example, if `{{styleInstruction}}` resolves to different text for adventure vs creative-writing mode:
```
{% if mode == 'adventure' %}Write in the style of an interactive fiction game...{% elsif mode == 'creative-writing' %}Write in the style of a skilled novelist...{% endif %}
```

**User decision: minimize duplication.** Shared text stays as the base; only differing parts wrapped in conditionals. Don't duplicate entire templates when they share most of their text.

**User decision: single pass only.** No `{% render %}` or partials. Each template is self-contained.

**Runtime placeholders stay as Liquid variables:**
- `{{recentContent}}`, `{{activeThreads}}`, `{{lorebookContext}}` etc. become `{{ recentContent }}`, `{{ activeThreads }}`, `{{ lorebookContext }}`
- These will be filled by ContextBuilder.add() at runtime

**Narrative templates (narrative.ts) -- template vs. service boundary clarification:**

Per locked decision "NarrativeService converted to template-based," the narrative templates must be comprehensive enough that `ContextBuilder.render('adventure')` or `render('creative-writing')` produces a complete system prompt. The boundary between what lives in templates vs. what stays in NarrativeService is:

- **Moves to templates (instruction TEXT):** Base narrator instructions, POV instructions ({% if pov == 'second' %}...), tense instructions, genre context sections, tone/themes sections, visual prose mode instructions, inline image mode instructions, world state section headers/wrappers, chapter summaries section wrapper, style guidance section wrapper. All of this is static instruction text that varies by mode/pov/tense and belongs in Liquid templates with conditionals.

- **Stays in NarrativeService (data FORMATTING):** `buildChapterSummariesBlock()` logic (formatting Chapter[] into a readable string), `StyleReviewerService.formatForPromptInjection()` (formatting StyleReviewResult into a string), tiered context block assembly (formatting world state objects into a string). These are data transformation functions that produce formatted strings. NarrativeService calls these formatters, then passes the resulting strings to ContextBuilder via `ctx.add()`.

- **How they connect:** Templates receive pre-formatted strings as Liquid variables. For example, the narrative template includes `{{ chapterSummaries }}` (receives the output of buildChapterSummariesBlock as a pre-formatted string), `{{ styleGuidance }}` (receives the output of formatForPromptInjection as a pre-formatted string), `{{ tieredContextBlock }}` (receives world state as a pre-formatted string), `{{ storyTime }}` (receives formatted time string). The template wraps these in section headers/conditional display logic, e.g.: `{% if chapterSummaries != '' %}<story_history>{{ chapterSummaries }}</story_history>{% endif %}`.

Study systemBuilder.ts to extract the instruction text portions (everything that is NOT data formatting) and move them into the narrative templates.

**Analysis templates (analysis.ts):** Classifier template -- convert macros to variables.

**Suggestions templates (suggestions.ts):** Already partially migrated. Convert any remaining macros.

**Generation templates (generation.ts):** Action choices and tier3-entry-selection templates.

Preserve the PromptTemplate interface structure (id, name, category, description, content, userContent). Only change the content/userContent strings.
  </action>
  <verify>
Run `npx svelte-check` -- 0 errors. Grep for `{{` in template content strings and verify all are valid Liquid syntax (space-padded `{{ var }}` or `{% tag %}`). No old MacroEngine macro tokens should remain (tokens without spaces like `{{macroName}}` that don't have a matching Liquid variable).
  </verify>
  <done>
All story, analysis, suggestions, and generation templates use Liquid syntax. Complex macro variants are inlined as {% if/elsif/else %} conditionals. Narrative templates include full system prompt instruction text previously in systemBuilder.ts, receiving pre-formatted data strings (chapterSummaries, styleGuidance, tieredContextBlock) as Liquid variables. No MacroEngine tokens remain.
  </done>
</task>

<task type="auto">
  <name>Task 2: Convert wizard, translation, memory, and image templates to Liquid syntax</name>
  <files>
    src/lib/services/prompts/templates/wizard.ts
    src/lib/services/prompts/templates/translation.ts
    src/lib/services/prompts/templates/memory.ts
    src/lib/services/prompts/templates/image.ts
  </files>
  <action>
Continue the template conversion for the remaining template files:

**Wizard templates (wizard.ts):** 11 templates for setting-expansion, setting-refinement, character-elaboration, character-refinement, protagonist-generation, supporting-characters, opening-generation-adventure, opening-generation-creative, opening-refinement-adventure, opening-refinement-creative, plus any others. Convert all macros to Liquid variables. These templates use `{{ genreLabel }}`, `{{ settingName }}`, `{{ protagonistName }}`, etc.

**Translation templates (translation.ts):** 6 templates for translate-narration, translate-input, translate-ui, translate-suggestions, translate-action-choices, translate-wizard-content. Convert macros to Liquid variables. Key variables: `{{ targetLanguage }}`, `{{ sourceLanguage }}`, `{{ content }}`.

User decision: TranslationService uses story context. So translation templates can access `{{ targetLanguage }}` and `{{ sourceLanguage }}` as system variables auto-populated from story.translationSettings by ContextBuilder.forStory().

**Memory templates (memory.ts):** Templates for chapter-summarization, chapter-analysis, retrieval-decision. Convert macros to Liquid variables.

**Image templates (image.ts):** The image-style-* templates are EXTERNAL templates per user decision. They should NOT have Liquid syntax -- they're raw text. Mark them appropriately but keep content as-is. Other image templates (if any analysis/generation ones exist) get Liquid conversion.

**Important for external templates:** The 6 external templates (`image-style-soft-anime`, `image-style-semi-realistic`, `image-style-photorealistic`, `interactive-lorebook`, `lorebook-classifier`, `vault-character-import`) must NOT contain `{{ }}` syntax. If they currently do, convert those to static text or remove the variables. These are raw text templates where services inject data programmatically.

Same rules as Task 1: preserve PromptTemplate structure, only change content strings, minimize duplication with conditionals, self-contained templates.
  </action>
  <verify>
Run `npx svelte-check` -- 0 errors. Verify all wizard/translation/memory templates use Liquid syntax. Verify external templates (image-style-*, interactive-lorebook, lorebook-classifier, vault-character-import) do NOT contain `{{ }}` or `{% %}` syntax. Count total templates and verify all are converted.
  </verify>
  <done>
All 40 templates converted: 34 standard templates use Liquid syntax, 6 external templates are raw text without variable syntax. Memory, wizard, translation templates all use proper Liquid variables and conditionals. PROMPT_TEMPLATES array structure unchanged.
  </done>
</task>

</tasks>

<verification>
- `npx svelte-check` passes with 0 errors
- All 40 templates in PROMPT_TEMPLATES have been reviewed and converted
- No MacroEngine-style tokens remain (complex macros like `{{styleInstruction}}` are now inlined as conditionals)
- Standard templates use `{{ variable }}` and `{% if/elsif/else/endif %}` syntax
- External templates are raw text only
- Template content works with flat namespace (direct variable access, no nesting)
- Narrative templates include full system prompt instruction text (mode/POV/tense instructions, genre, tone)
- Narrative templates receive data as pre-formatted strings via {{ chapterSummaries }}, {{ styleGuidance }}, {{ tieredContextBlock }} -- NOT raw objects
</verification>

<success_criteria>
- All prompt template files converted from macro syntax to Liquid syntax
- Complex macros inlined as Liquid conditionals
- External templates identified and kept as raw text
- TypeScript compilation passes
- Templates are self-contained (no partials/includes)
- Narrative template/service boundary clear: instruction text in templates, data formatting in NarrativeService
</success_criteria>

<output>
After completion, create `.planning/phases/03-context-system-service-integration/03-02-SUMMARY.md`
</output>
