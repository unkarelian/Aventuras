---
phase: 03-context-system-service-integration
plan: 05
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - src/lib/services/ai/wizard/ScenarioService.ts
  - src/lib/services/ai/utils/TranslationService.ts
  - src/lib/services/ai/image/ImageAnalysisService.ts
  - src/lib/services/ai/image/BackgroundImageService.ts
  - src/lib/services/ai/image/InlineImageService.ts
  - src/lib/services/ai/image/InlineImageTracker.ts
  - src/lib/services/ai/index.ts
autonomous: true

must_haves:
  truths:
    - "ScenarioService (wizard) uses ContextBuilder.forWizard() for progressive context during wizard steps"
    - "TranslationService uses ContextBuilder.forStory(storyId) to get targetLanguage/sourceLanguage from story settings automatically"
    - "Image services use ContextBuilder for prompt rendering (external templates return raw content)"
    - "None of these services import from '$lib/services/prompts' anymore"
    - "Wizard context is progressive -- early steps have fewer variables available"
  artifacts:
    - path: "src/lib/services/ai/wizard/ScenarioService.ts"
      provides: "Wizard scenario generation using ContextBuilder.forWizard()"
      contains: "ContextBuilder.forWizard"
    - path: "src/lib/services/ai/utils/TranslationService.ts"
      provides: "Translation using story context"
      contains: "ContextBuilder.forStory"
    - path: "src/lib/services/ai/image/BackgroundImageService.ts"
      provides: "Image services using ContextBuilder"
      contains: "ContextBuilder"
  key_links:
    - from: "src/lib/services/ai/wizard/ScenarioService.ts"
      to: "src/lib/services/context/context-builder.ts"
      via: "ContextBuilder.forWizard() for progressive wizard context"
      pattern: "ContextBuilder\\.forWizard"
    - from: "src/lib/services/ai/utils/TranslationService.ts"
      to: "src/lib/services/context/context-builder.ts"
      via: "ContextBuilder.forStory() for story-based translation context"
      pattern: "ContextBuilder\\.forStory"
---

<objective>
Migrate wizard (ScenarioService), translation (TranslationService), and image services to the ContextBuilder pipeline.

Purpose: Completes the service migration covering SVC-08 (wizard), SVC-12 (translation), and SVC-11 (image services). The wizard migration is notable because it uses ContextBuilder.forWizard() with progressive context. The translation migration is notable because it switches from a hardcoded TRANSLATION_CONTEXT to story-derived context per user decision.

Output: All 7 files use ContextBuilder instead of promptService.
</objective>

<execution_context>
@C:/Users/Admin/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-context-system-service-integration/03-CONTEXT.md
@.planning/phases/03-context-system-service-integration/03-01-SUMMARY.md
@.planning/phases/03-context-system-service-integration/03-02-SUMMARY.md

# ContextBuilder
@src/lib/services/context/context-builder.ts
@src/lib/services/context/types.ts
@src/lib/services/context/index.ts

# Services to migrate
@src/lib/services/ai/wizard/ScenarioService.ts
@src/lib/services/ai/utils/TranslationService.ts
@src/lib/services/ai/image/ImageAnalysisService.ts
@src/lib/services/ai/image/BackgroundImageService.ts
@src/lib/services/ai/image/InlineImageService.ts
@src/lib/services/ai/image/InlineImageTracker.ts
@src/lib/services/ai/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate ScenarioService (wizard) to ContextBuilder.forWizard()</name>
  <files>
    src/lib/services/ai/wizard/ScenarioService.ts
  </files>
  <action>
ScenarioService is the largest file to migrate (~1100 lines). It has many methods that all follow the same pattern: build PromptContext, call promptService.renderPrompt/renderUserPrompt.

**Key change: Use ContextBuilder.forWizard() instead of getWizardPromptContext():**

The existing `getWizardPromptContext()` private method builds a minimal PromptContext. Replace with ContextBuilder.forWizard():

```typescript
// Old:
const promptContext = this.getWizardPromptContext(mode, pov, tense, protagonistName)
const system = promptService.renderPrompt('setting-expansion', promptContext, { ... })
const prompt = promptService.renderUserPrompt('setting-expansion', promptContext, { ... })

// New:
const ctx = ContextBuilder.forWizard({ mode, pov, tense, protagonistName, genre: genreLabel }, stepNumber)
ctx.add({ genreLabel, seed, lorebookContext, customInstruction })
const { system, user: prompt } = await ctx.render('setting-expansion')
```

**Per method migration:**

1. `expandSetting` -- step 2 (setting creation): genre, seed available
2. `refineSetting` -- step 2: genre, current setting data available
3. `elaborateCharacter` -- step 4 (character creation): genre, setting, character input available
4. `refineCharacter` -- step 4: genre, setting, current character available
5. `generateProtagonist` -- step 4: genre, setting, mode, pov available
6. `generateCharacters` -- step 5 (supporting characters): genre, setting, protagonist available
7. `generateOpening` / `refineOpening` -- step 7 (opening generation): all wizard data available

**Progressive context:**
- Step 2 wizard context: genre, packId (from wizard pack selection)
- Step 4 wizard context: + settingDescription, settingName, atmosphere, themes
- Step 5 wizard context: + protagonistName, protagonistDescription
- Step 7 wizard context: + all characters, writing style, title

The ContextBuilder.forWizard() handles this -- it knows which system variables are available at each step. Runtime variables (formatted data from the service) are always available via ctx.add().

**User decision: wizard uses same ContextBuilder as story.** The forWizard method returns a ContextBuilder that works identically to forStory, just with progressive variable availability.

**Preserve non-prompt methods:** `prepareStoryData()`, `capitalizeGenre()`, helper methods that format data stay unchanged. Only replace the prompt rendering flow.

**Remove:**
- `import { promptService, type PromptContext } from '$lib/services/prompts'`
- `private getWizardPromptContext()` method (replaced by ContextBuilder.forWizard)
- All direct promptService calls

**Add:**
- `import { ContextBuilder } from '$lib/services/context'`

**The buildSystemPrompt method in ScenarioService** (used by prepareStoryData) currently uses promptService to render adventure/creative-writing templates. Replace with ContextBuilder too, or since this is generating the initial story system prompt, it may need a different approach. Check usage and handle accordingly.
  </action>
  <verify>
Run `npx svelte-check` -- 0 errors. Grep for `promptService` in ScenarioService.ts -- should not be found. Verify ContextBuilder.forWizard is used. Verify all 8+ wizard prompt generation methods are migrated. Verify prepareStoryData still works.
  </verify>
  <done>
ScenarioService uses ContextBuilder.forWizard() for progressive wizard context. All wizard methods migrated: expandSetting, refineSetting, elaborateCharacter, refineCharacter, generateProtagonist, generateCharacters, generateOpening, refineOpening. No imports from '$lib/services/prompts'.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate TranslationService and image services</name>
  <files>
    src/lib/services/ai/utils/TranslationService.ts
    src/lib/services/ai/image/ImageAnalysisService.ts
    src/lib/services/ai/image/BackgroundImageService.ts
    src/lib/services/ai/image/InlineImageService.ts
    src/lib/services/ai/image/InlineImageTracker.ts
    src/lib/services/ai/index.ts
  </files>
  <action>
**TranslationService migration:**

User decision: "TranslationService uses story context -- calls contextBuilder.forStory(storyId), gets targetLanguage/sourceLanguage from story translation settings automatically."

Current state: TranslationService uses a hardcoded `TRANSLATION_CONTEXT` with dummy values:
```typescript
const TRANSLATION_CONTEXT: PromptContext = {
  mode: 'creative-writing', pov: 'third', tense: 'past', protagonistName: ''
}
```

New approach:
1. Add storyId parameter to translation methods (or pass it through from callers)
2. Use `const ctx = await ContextBuilder.forStory(storyId)` -- this auto-populates targetLanguage and sourceLanguage from story.translationSettings
3. Add runtime data: `ctx.add({ content })` for narration translation, `ctx.add({ elementsJson })` for UI translation, etc.
4. Render: `const { system, user: prompt } = await ctx.render('translate-narration')`
5. Remove the `TRANSLATION_CONTEXT` constant

For translation methods that don't have a storyId (if any), fall back to a minimal context. But per user decision, translations should use story context.

Methods to migrate:
- translateNarration(content, targetLanguage) -> needs storyId
- translateInput(content, sourceLanguage) -> needs storyId
- translateUIElements(items, targetLanguage) -> needs storyId
- translateSuggestions(suggestions, targetLanguage) -> needs storyId
- translateActionChoices(choices, targetLanguage) -> needs storyId
- translateWizardContent(content, targetLanguage) -> may not have storyId (wizard context)
- translateWizardBatch(fields, targetLanguage) -> may not have storyId

For wizard translations, use ContextBuilder.forWizard() or a simple context approach.

**Image services migration:**

Read each image service file to understand its promptService usage:

- **ImageAnalysisService:** Likely uses promptService for image analysis prompts. Standard migration.
- **BackgroundImageService:** Uses promptService. May use image-style templates (external). Standard migration with external template handling.
- **InlineImageService:** Uses promptService. Similar to BackgroundImageService.
- **InlineImageTracker:** Uses promptService. Check specific usage.

For image services that use external templates (image-style-*), the ContextBuilder.render() returns raw content without Liquid rendering. The service then builds the full prompt by concatenation, same as before.

**AI index.ts (src/lib/services/ai/index.ts):**
This file imports WorldStateContext from systemBuilder. Update to import from the appropriate location (either the generation/ContextBuilder or the new context types).

For each file:
1. Remove imports from '$lib/services/prompts'
2. Add import from '$lib/services/context'
3. Replace all promptService calls with ContextBuilder pattern
4. Adjust method signatures if storyId is needed
  </action>
  <verify>
Run `npx svelte-check` -- 0 errors. Grep for `promptService` in all 6 files -- should not be found. Verify TranslationService uses ContextBuilder.forStory (not hardcoded TRANSLATION_CONTEXT). Verify image services handle external templates correctly.
  </verify>
  <done>
TranslationService uses story context via ContextBuilder.forStory(storyId). Image services migrated with proper external template handling. AI index updated. All 7 files import from '$lib/services/context', none from '$lib/services/prompts'.
  </done>
</task>

</tasks>

<verification>
- `npx svelte-check` passes with 0 errors
- 7 files migrated total
- ScenarioService uses ContextBuilder.forWizard() for progressive wizard context
- TranslationService uses ContextBuilder.forStory() for story-derived language settings
- Image services handle external templates (raw content, no Liquid rendering)
- No file imports from '$lib/services/prompts'
- Requirements covered: SVC-08, SVC-11, SVC-12
</verification>

<success_criteria>
- ScenarioService wizard methods use ContextBuilder.forWizard()
- TranslationService uses story context (not hardcoded TRANSLATION_CONTEXT)
- Image services migrated with external template handling
- AI index.ts updated
- TypeScript compilation passes
- No references to old promptService in any of these files
</success_criteria>

<output>
After completion, create `.planning/phases/03-context-system-service-integration/03-05-SUMMARY.md`
</output>
