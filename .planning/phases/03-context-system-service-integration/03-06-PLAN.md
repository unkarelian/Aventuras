---
phase: 03-context-system-service-integration
plan: 06
type: execute
wave: 4
depends_on: ["03-03", "03-04", "03-05"]
files_modified:
  - src/lib/services/prompts/macros.ts
  - src/lib/services/prompts/index.ts
  - src/lib/services/prompts/types.ts
  - src/lib/services/prompts/definitions.ts
  - src/lib/services/prompts/definitions/index.ts
  - src/lib/services/prompts/definitions/macros/core.ts
  - src/lib/services/prompts/definitions/macros/narrative.ts
  - src/lib/services/prompts/definitions/macros/features.ts
  - src/lib/services/prompts/definitions/macros/context.ts
  - src/lib/services/prompts/definitions/macros/placeholders.ts
  - src/lib/services/prompts/definitions/macros/index.ts
  - src/lib/services/ai/prompts/systemBuilder.ts
  - src/lib/services/ai/generation/index.ts
autonomous: true

must_haves:
  truths:
    - "No file in the codebase imports from '$lib/services/prompts' (the old prompt system)"
    - "MacroEngine class is deleted (macros.ts)"
    - "PromptService class is deleted (prompts/index.ts)"
    - "systemBuilder.ts is deleted"
    - "All macro definition files are deleted"
    - "The PROMPT_TEMPLATES array and template files are preserved (still needed by pack seeding and ContextBuilder)"
  artifacts:
    - path: "src/lib/services/prompts/index.ts"
      provides: "Simplified re-export of templates only (no PromptService, no MacroEngine)"
      contains: "PROMPT_TEMPLATES"
    - path: "src/lib/services/prompts/macros.ts"
      provides: "File deleted"
  key_links:
    - from: "src/lib/services/packs/pack-service.ts"
      to: "src/lib/services/prompts/templates/index.ts"
      via: "PROMPT_TEMPLATES import for pack seeding"
      pattern: "PROMPT_TEMPLATES"
---

<objective>
Delete the old PromptService, MacroEngine, systemBuilder, and all macro definition files. Clean up any remaining references.

Purpose: User decision: "Old PromptService and MacroEngine deleted in this phase -- not deferred to Phase 6." With all services migrated in Plans 03-05, the old prompt system is dead code. Removing it ensures no accidental usage and reduces confusion.

Output: Old prompt system files deleted. Only PROMPT_TEMPLATES and template definition files preserved (needed by PackService for seeding and by ContextBuilder for template content).
</objective>

<execution_context>
@C:/Users/Admin/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-context-system-service-integration/03-CONTEXT.md
@.planning/phases/03-context-system-service-integration/03-03-SUMMARY.md
@.planning/phases/03-context-system-service-integration/03-04-SUMMARY.md
@.planning/phases/03-context-system-service-integration/03-05-SUMMARY.md

# Files to delete/modify
@src/lib/services/prompts/macros.ts
@src/lib/services/prompts/index.ts
@src/lib/services/prompts/types.ts
@src/lib/services/prompts/definitions.ts
@src/lib/services/prompts/definitions/index.ts
@src/lib/services/prompts/definitions/macros/core.ts
@src/lib/services/prompts/definitions/macros/index.ts
@src/lib/services/ai/prompts/systemBuilder.ts
@src/lib/services/ai/generation/index.ts

# PackService still imports PROMPT_TEMPLATES
@src/lib/services/packs/pack-service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete MacroEngine, PromptService, and macro definitions</name>
  <files>
    src/lib/services/prompts/macros.ts
    src/lib/services/prompts/index.ts
    src/lib/services/prompts/types.ts
    src/lib/services/prompts/definitions.ts
    src/lib/services/prompts/definitions/index.ts
    src/lib/services/prompts/definitions/macros/core.ts
    src/lib/services/prompts/definitions/macros/narrative.ts
    src/lib/services/prompts/definitions/macros/features.ts
    src/lib/services/prompts/definitions/macros/context.ts
    src/lib/services/prompts/definitions/macros/placeholders.ts
    src/lib/services/prompts/definitions/macros/index.ts
    src/lib/services/ai/prompts/systemBuilder.ts
  </files>
  <action>
**Step 1: Verify no remaining imports.**

Before deleting anything, search the entire codebase for imports from the old prompt system:
```
grep -r "from '\$lib/services/prompts'" src/
grep -r "from '\$lib/services/ai/prompts'" src/
```

If any files still import from these paths, they were missed in Plans 03-05 and need to be migrated first. Fix any remaining imports before proceeding with deletion.

Also check for imports from promptService in non-service files:
- Store files (settings.svelte.ts, story.svelte.ts)
- Component files
- Route files
- Any other files

**Step 2: Delete macro system files.**

Delete these files entirely (they contain only MacroEngine/macro-related code):
- `src/lib/services/prompts/macros.ts` -- MacroEngine class
- `src/lib/services/prompts/definitions/macros/core.ts` -- Core macro definitions
- `src/lib/services/prompts/definitions/macros/narrative.ts` -- Narrative macro definitions
- `src/lib/services/prompts/definitions/macros/features.ts` -- Feature macro definitions
- `src/lib/services/prompts/definitions/macros/context.ts` -- Context macro definitions
- `src/lib/services/prompts/definitions/macros/placeholders.ts` -- Placeholder definitions
- `src/lib/services/prompts/definitions/macros/index.ts` -- Macro barrel file

Delete systemBuilder:
- `src/lib/services/ai/prompts/systemBuilder.ts` -- Manual system prompt assembly (replaced by templates + ContextBuilder)

**Step 3: Simplify prompts/index.ts.**

The prompts/index.ts currently exports PromptService, macroEngine, types, definitions. Rewrite it to only export what's still needed:

- `PROMPT_TEMPLATES` -- still needed by PackService for seeding
- `hasUserContent` and `getTemplateById` utility functions if still used
- PromptTemplate type -- still needed

Remove:
- `promptService` singleton
- `macroEngine` export
- `BUILTIN_MACROS`, `CONTEXT_PLACEHOLDERS` exports
- All macro-related type re-exports (Macro, MacroOverride, PromptSettings, etc.)

**Step 4: Clean up types.ts.**

Remove macro-related types from `src/lib/services/prompts/types.ts`:
- `MacroType`, `VariantKey`, `MacroVariant`, `SimpleMacro`, `ComplexMacro`, `Macro`
- `ContextPlaceholder`
- `MacroOverride`, `PromptSettings`, `getDefaultPromptSettings`
- `PromptContext` (replaced by flat context in ContextBuilder)

Keep:
- `PromptTemplate` interface (still used by PROMPT_TEMPLATES)
- `PromptCategory` type (still used by templates)
- `StoryMode`, `POV`, `Tense` re-exports (if other code imports them from here -- check first, they may be imported from '$lib/types' directly)

**Step 5: Clean up definitions.ts and definitions/index.ts.**

These files aggregate macro definitions + template definitions. Remove all macro-related exports. Keep PROMPT_TEMPLATES-related exports:
- `getTemplateById` function
- `hasUserContent` function
- Remove `BUILTIN_MACROS`, `CONTEXT_PLACEHOLDERS`

**Step 6: Delete the src/lib/services/ai/prompts/ directory if empty after systemBuilder removal.**
  </action>
  <verify>
Run `npx svelte-check` -- 0 errors. Verify deleted files don't exist. Grep entire src/ for `promptService` -- should only appear in deleted file references or comments, not in active imports. Grep for `macroEngine` -- should not be found anywhere. Grep for `MacroEngine` -- should not be found. Verify PROMPT_TEMPLATES is still accessible and PackService still compiles.
  </verify>
  <done>
MacroEngine deleted. PromptService deleted. systemBuilder deleted. All macro definition files deleted. prompts/index.ts simplified to template exports only. No file in codebase imports old PromptService or MacroEngine. PROMPT_TEMPLATES preserved for PackService seeding.
  </done>
</task>

<task type="auto">
  <name>Task 2: Final cleanup and import verification</name>
  <files>
    src/lib/services/ai/generation/index.ts
  </files>
  <action>
**Clean up generation/index.ts:**
The `src/lib/services/ai/generation/index.ts` barrel file may re-export types from systemBuilder (like WorldStateContext). Update it to:
- Remove any re-exports from systemBuilder.ts
- If WorldStateContext is still needed by other code, re-export it from the generation/ContextBuilder.ts (the tiered context builder) which also defines it
- Update any remaining type imports

**Full codebase sweep:**
Do a final comprehensive search for any remaining references to the old prompt system:

1. Search for `from '$lib/services/prompts'` -- should only exist in template files themselves (importing types for their own definitions) and in the barrel re-exports
2. Search for `PromptService` -- should not exist as a class reference
3. Search for `macroEngine` -- should not exist
4. Search for `BUILTIN_MACROS` -- should not exist
5. Search for `CONTEXT_PLACEHOLDERS` -- should not exist
6. Search for `buildSystemPrompt` from systemBuilder -- should not exist
7. Search for `buildPrimingMessage` from systemBuilder -- should not exist

Fix any remaining references found.

**Verify PackService still works:**
PackService imports `PROMPT_TEMPLATES` from `$lib/services/prompts/templates`. Verify this import path still works after the cleanup.

**Verify settings store:**
Settings store may reference `PromptSettings`, `getDefaultPromptSettings`, or store macro overrides. Check `src/lib/stores/settings.svelte.ts` for any references to the old prompt system types. If found, remove or update them. The old promptService.init(settings) call in app startup code also needs to be removed.

**Verify app startup:**
Check where `promptService.init()` is called (likely in +page.svelte or app initialization). Remove that initialization call. Replace with `packService.initialize()` if not already called.
  </action>
  <verify>
Run `npx svelte-check` -- 0 errors. Full codebase grep for `promptService` as an identifier (not in comments/strings) returns 0 results. Grep for `MacroEngine` returns 0 results. Grep for `buildSystemPrompt` returns 0 results. App builds successfully.
  </verify>
  <done>
Complete cleanup verified. No references to old PromptService, MacroEngine, or systemBuilder anywhere in codebase. Generation index updated. Settings store cleaned. App startup updated. PROMPT_TEMPLATES preserved and accessible. TypeScript compilation passes with 0 errors.
  </done>
</task>

</tasks>

<verification>
- `npx svelte-check` passes with 0 errors
- `src/lib/services/prompts/macros.ts` does not exist
- `src/lib/services/ai/prompts/systemBuilder.ts` does not exist
- `src/lib/services/prompts/definitions/macros/` directory is empty or deleted
- Grep for `promptService` in src/ returns 0 active import references
- Grep for `MacroEngine` in src/ returns 0 results
- Grep for `buildSystemPrompt` in src/ returns 0 results
- PROMPT_TEMPLATES still importable from prompts/templates
- PackService compiles and references PROMPT_TEMPLATES correctly
- App builds and starts without errors
</verification>

<success_criteria>
- MacroEngine, PromptService, systemBuilder completely removed
- All macro definition files deleted
- No codebase references to deleted code
- prompts/ module simplified to template definitions only
- PROMPT_TEMPLATES preserved for pack seeding
- Full TypeScript compilation passes
- App startup works without old promptService.init()
</success_criteria>

<output>
After completion, create `.planning/phases/03-context-system-service-integration/03-06-SUMMARY.md`
</output>
