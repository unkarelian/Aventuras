---
phase: 03-context-system-service-integration
plan: 04
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - src/lib/services/ai/generation/MemoryService.ts
  - src/lib/services/ai/generation/StyleReviewerService.ts
  - src/lib/services/ai/generation/ContextBuilder.ts
  - src/lib/services/ai/lorebook/InteractiveLorebookService.ts
  - src/lib/services/ai/lorebook/LoreManagementService.ts
  - src/lib/services/ai/retrieval/AgenticRetrievalService.ts
  - src/lib/services/ai/retrieval/EntryRetrievalService.ts
  - src/lib/services/ai/retrieval/TimelineFillService.ts
autonomous: true

must_haves:
  truths:
    - "MemoryService uses ContextBuilder for all 3 prompt generation methods (summarize, analyze, decideRetrieval)"
    - "StyleReviewerService uses ContextBuilder for style analysis prompt generation"
    - "LoreManagementService and InteractiveLorebookService use ContextBuilder for prompt generation"
    - "Retrieval services (Agentic, EntryRetrieval, TimelineFill) use ContextBuilder for prompt generation"
    - "The existing ContextBuilder in generation/ (tiered injection) is updated to not import from prompts"
    - "None of these services import from '$lib/services/prompts' anymore"
  artifacts:
    - path: "src/lib/services/ai/generation/MemoryService.ts"
      provides: "Memory service using unified pipeline"
      contains: "ContextBuilder.forStory"
    - path: "src/lib/services/ai/generation/StyleReviewerService.ts"
      provides: "Style reviewer using unified pipeline"
      contains: "ContextBuilder.forStory"
    - path: "src/lib/services/ai/lorebook/LoreManagementService.ts"
      provides: "Lore management using unified pipeline"
      contains: "ContextBuilder"
  key_links:
    - from: "src/lib/services/ai/generation/MemoryService.ts"
      to: "src/lib/services/context/context-builder.ts"
      via: "ContextBuilder for prompt rendering"
      pattern: "ContextBuilder"
    - from: "src/lib/services/ai/lorebook/LoreManagementService.ts"
      to: "src/lib/services/context/context-builder.ts"
      via: "ContextBuilder for prompt rendering"
      pattern: "ContextBuilder"
---

<objective>
Migrate support services (MemoryService, StyleReviewerService, lorebook services, retrieval services) and update the existing generation/ContextBuilder to use the new unified pipeline.

Purpose: These services provide supporting AI operations (memory summarization, style analysis, lorebook management, context retrieval). Migrating them completes SVC-07 (MemoryService), SVC-09 (StyleReviewerService), SVC-10 (LoreManagementService) requirements, plus the retrieval services that also use promptService.

Output: All 8 files migrated to use ContextBuilder from the new context module instead of promptService.
</objective>

<execution_context>
@C:/Users/Admin/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-context-system-service-integration/03-CONTEXT.md
@.planning/phases/03-context-system-service-integration/03-01-SUMMARY.md
@.planning/phases/03-context-system-service-integration/03-02-SUMMARY.md

# ContextBuilder (from Plan 01)
@src/lib/services/context/context-builder.ts
@src/lib/services/context/index.ts

# Services to migrate
@src/lib/services/ai/generation/MemoryService.ts
@src/lib/services/ai/generation/StyleReviewerService.ts
@src/lib/services/ai/generation/ContextBuilder.ts
@src/lib/services/ai/lorebook/InteractiveLorebookService.ts
@src/lib/services/ai/lorebook/LoreManagementService.ts
@src/lib/services/ai/retrieval/AgenticRetrievalService.ts
@src/lib/services/ai/retrieval/EntryRetrievalService.ts
@src/lib/services/ai/retrieval/TimelineFillService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate MemoryService, StyleReviewerService, and generation ContextBuilder</name>
  <files>
    src/lib/services/ai/generation/MemoryService.ts
    src/lib/services/ai/generation/StyleReviewerService.ts
    src/lib/services/ai/generation/ContextBuilder.ts
  </files>
  <action>
**MemoryService migration:**
MemoryService has 3 methods that use promptService: `summarizeChapter`, `analyzeForChapter`, `decideRetrieval`.

For each method:
1. Remove PromptContext construction
2. Create ContextBuilder: `const ctx = await ContextBuilder.forStory(storyId)`
   - MemoryService methods currently take mode/pov/tense strings but no storyId. Add storyId parameter to each method, or if story context isn't critical for memory operations (the templates just need basic mode/pov/tense), consider using a minimal ContextBuilder approach.
   - Check if MemoryService can get storyId from the caller. If the caller already has storyId, pass it through. If not, the service can build context with available parameters.
   - Alternative: If storyId isn't available, the ContextBuilder could have a `forContext(data)` static method for services that don't have a story. Or the service can pass mode/pov/tense through ctx.add().
3. Add runtime data via ctx.add()
4. Render via ctx.render()

The key runtime variables per template:
- chapter-summarization: `chapterContent`, `previousContext`
- chapter-analysis: `messagesInRange`, `firstValidId`, `lastValidId`
- retrieval-decision: `userInput`, `recentContext`, `chapterSummaries`, `maxChaptersPerRetrieval`

**StyleReviewerService migration:**
Single method `analyzeStyle`:
1. Replace promptService.renderPrompt/renderUserPrompt with ContextBuilder
2. Needs storyId (or at minimum mode/pov/tense). Add storyId parameter.
3. Runtime variables: `passageCount`, `passages`
4. Template: 'style-reviewer'

**Generation ContextBuilder (src/lib/services/ai/generation/ContextBuilder.ts) update:**
This is the EXISTING tiered context builder for world state injection (Tier 1/2/3). It's a different class from the new context/ContextBuilder. It currently imports `promptService` for the Tier 3 LLM selection prompt.

Update it to:
1. Import from `$lib/services/context` instead of `$lib/services/prompts`
2. For Tier 3 selection, use the new ContextBuilder to render the 'tier3-entry-selection' template
3. This may require renaming to avoid confusion with the new ContextBuilder. Consider renaming this class to `WorldStateBuilder` or `TieredContextBuilder`. Or keep it as-is since it's in a different module path.

IMPORTANT: Be careful not to create circular dependencies. The new context/ContextBuilder does NOT depend on generation/ContextBuilder. The generation/ContextBuilder just uses promptService for one template render -- replace that with the new context/ContextBuilder.
  </action>
  <verify>
Run `npx svelte-check` -- 0 errors. Grep for `promptService` in MemoryService.ts, StyleReviewerService.ts, generation/ContextBuilder.ts -- should not be found. Verify each uses imports from '$lib/services/context'.
  </verify>
  <done>
MemoryService, StyleReviewerService, and generation/ContextBuilder all migrated to new pipeline. No imports from '$lib/services/prompts'. Memory operations render through unified pipeline. Style analysis renders through unified pipeline.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate lorebook and retrieval services</name>
  <files>
    src/lib/services/ai/lorebook/InteractiveLorebookService.ts
    src/lib/services/ai/lorebook/LoreManagementService.ts
    src/lib/services/ai/retrieval/AgenticRetrievalService.ts
    src/lib/services/ai/retrieval/EntryRetrievalService.ts
    src/lib/services/ai/retrieval/TimelineFillService.ts
  </files>
  <action>
Migrate all 5 services following the standard pattern.

For each service:
1. Remove `import { promptService } from '$lib/services/prompts'` (and any PromptContext import)
2. Add `import { ContextBuilder } from '$lib/services/context'`
3. Replace each `promptService.renderPrompt()` / `promptService.renderUserPrompt()` call with ContextBuilder flow

**InteractiveLorebookService:** Read the file to understand its promptService usage. It likely renders interactive lorebook prompts. This uses an EXTERNAL template ('interactive-lorebook') per user decision -- ContextBuilder.render() will return the raw content without Liquid rendering for external templates.

**LoreManagementService:** Read to understand its promptService usage. May use 'lorebook-classifier' template (another external template).

**AgenticRetrievalService:** Uses promptService for retrieval prompts. Standard migration.

**EntryRetrievalService:** Uses promptService. Standard migration.

**TimelineFillService:** Uses promptService for timeline fill prompts. Standard migration.

For services that use external templates, the ContextBuilder.render() already handles the bypass (returns raw content). The service then appends data programmatically as before.

For services that don't have a storyId easily available, check what data they do have and use the most appropriate ContextBuilder factory method. If a service only needs the template text and doesn't care about story context, a simple render that just loads the template and applies minimal context may suffice.

Keep all existing data formatting logic in each service. Only replace the prompt rendering step.
  </action>
  <verify>
Run `npx svelte-check` -- 0 errors. Grep for `promptService` in all 5 files -- should not be found. Verify each imports from '$lib/services/context'. Verify external template handling works correctly for lorebook services.
  </verify>
  <done>
All 5 services migrated: InteractiveLorebookService, LoreManagementService, AgenticRetrievalService, EntryRetrievalService, TimelineFillService. No imports from '$lib/services/prompts'. External templates handled correctly (raw content, no Liquid rendering).
  </done>
</task>

</tasks>

<verification>
- `npx svelte-check` passes with 0 errors
- 8 files migrated total
- No file imports from '$lib/services/prompts'
- Memory operations (summarize, analyze, retrieve) use unified pipeline
- Style review uses unified pipeline
- Lorebook services use unified pipeline (with external template bypass where appropriate)
- Retrieval services use unified pipeline
- Requirements covered: SVC-07, SVC-09, SVC-10 (partially)
</verification>

<success_criteria>
- MemoryService, StyleReviewerService migrated to ContextBuilder
- Lorebook services migrated (external templates handled correctly)
- Retrieval services migrated
- Generation ContextBuilder updated to not use promptService
- TypeScript compilation passes
- No references to old promptService in any of these 8 files
</success_criteria>

<output>
After completion, create `.planning/phases/03-context-system-service-integration/03-04-SUMMARY.md`
</output>
